**Crochet Pattern Helper**

Track crochet projects and stitches! 

This repository uses:
- Supabase authentication and Postgres with RLS
- Server and browser clients via the SSR helpers
- Middleware‑based session synchronization for protected routes
- TypeScript server actions for mutations

---

## Quickstart

1) Prerequisites
- Node.js 18+
- pnpm (or npm)
- A Supabase project with Email/Password auth enabled

2) Configure environment
- Copy `.env.example` to `.env.local` and fill in the values from your project settings:
```
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```
- Do not expose a service role key in the app. Keep secrets server‑side only.

3) Install and run
```
pnpm install
pnpm dev
```
Open http://localhost:3000

---

## Database Schema (SQL)

Create two tables: `projects` (one per pattern) and `stitches` (per‑project counters). The schema below assumes every project slug is unique per user.

```sql
-- Enable pgcrypto if you want UUIDs (optional)
-- create extension if not exists "pgcrypto";

-- Users are managed by auth; we reference auth.uid()

create table if not exists public.projects (
  id bigint generated by default as identity primary key,
  user_id uuid not null,
  name text not null,
  slug text not null,
  description text,
  inserted_at timestamp with time zone default now(),
  updated_at timestamp with time zone default now(),
  constraint projects_user_slug_unique unique (user_id, slug)
);

create table if not exists public.stitches (
  id bigint generated by default as identity primary key,
  project_slug text not null,
  total_rows int not null,
  total_repeats int not null,
  current_row int not null default 0,
  current_repeat int not null default 0,
  inserted_at timestamp with time zone default now(),
  updated_at timestamp with time zone default now(),
  constraint stitches_project_fk foreign key (project_slug)
    references public.projects (slug)
    on delete cascade
);

-- Helpful indexes
create index if not exists projects_user_idx on public.projects (user_id);
create index if not exists projects_slug_idx on public.projects (slug);
create index if not exists stitches_project_slug_idx on public.stitches (project_slug);
```

### Row Level Security (RLS)

Enable RLS and restrict every operation to the authenticated owner.

```sql
alter table public.projects enable row level security;
alter table public.stitches enable row level security;

-- Project policies
create policy projects_select on public.projects
  for select using (auth.uid() = user_id);
create policy projects_insert on public.projects
  for insert with check (auth.uid() = user_id);
create policy projects_update on public.projects
  for update using (auth.uid() = user_id);
create policy projects_delete on public.projects
  for delete using (auth.uid() = user_id);

-- Stitches policies: join via project ownership
create policy stitches_select on public.stitches
  for select using (exists (
    select 1 from public.projects p
    where p.slug = stitches.project_slug
      and p.user_id = auth.uid()
  ));
create policy stitches_insert on public.stitches
  for insert with check (exists (
    select 1 from public.projects p
    where p.slug = stitches.project_slug
      and p.user_id = auth.uid()
  ));
create policy stitches_update on public.stitches
  for update using (exists (
    select 1 from public.projects p
    where p.slug = stitches.project_slug
      and p.user_id = auth.uid()
  ));
create policy stitches_delete on public.stitches
  for delete using (exists (
    select 1 from public.projects p
    where p.slug = stitches.project_slug
      and p.user_id = auth.uid()
  ));
```

---

## Supabase Usage

- Auth: Email + Password via the JS client. Login, signup, signout, and password reset live in server actions under `src/app/actions/auth/*`.
- Session sync: `middleware.ts` calls `updateSession` (`src/lib/supabase/middleware.ts`) to read/write auth cookies and redirect unauthenticated users to `/login`.
- SSR server client: `src/lib/supabase/server.ts` uses `createServerClient` with the request cookie store. Components fetch data server‑side with RLS enforced.
- Browser client: `src/lib/supabase/client.ts` exposes a `createClient()` for client components if needed.
- Data model: All reads/writes occur against RLS‑protected tables; user ownership is asserted both in queries and by policies.

Key flows in this repo:
- Project dashboard: `src/app/page.tsx` fetches projects for the logged‑in user.
- Create/update project: `src/app/actions/projects/create-update.ts` upserts project + stitches in a single path.
- Stitch counter: `src/components/StitchCounter/*` debounces writes and persists progress with `changeCount` server action.

---

## Development Notes

- Scripts: `pnpm dev`, `pnpm build`, `pnpm start`, `pnpm lint`
- Styling: Tailwind CSS; see `tailwind.config.ts`
- Routing: App Router (`src/app/*`)
- Icons: `lucide-react`

---

## Deployment

Set the same environment variables in your hosting provider:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

Build and run:
```
pnpm build
pnpm start
```

---

## License

MIT

